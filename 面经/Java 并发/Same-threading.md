Same-threading 是一个并发模型从单线程系统扩展到多个单线程系统，多个单线程可以并发执行。

一个 Same-threading 系统不是纯粹的单线程系统，因为它包括多个线程，虽然每个线程运行像单个线程系统一样，因此使用【 Same-threading 】术语代替 单线程。

## 为什么使用单线程系统？

你是否好奇，当今为什么所有人都设计单线程系统，单线程系统如此流行的原因是这种并发模型比多线程系统更加简单。单线程系统不需要考虑和其他线程共享状态（object/data）的问题，单线程可以使用非并发数据结构，并且能够更好的使用CPU 和 CPU 缓存。

可惜的事，单线程系统不能更好的利用现代 CPU（多核多线程 CPU），一个现代 CPU 通常有 2，4，6，8或者更多的核心，每个核心 functions 作为一个独立的 CPU，一个单线程系统仅仅只能使用其中一个核心，就像下图这样：
img

## Same-threading 是对单线程的扩展

为了提高 CPU 所有核心的利用，一个单线程系统可以被扩展利用整个计算机，

### 一个线程一个 CPU

Same-threading 系统在计算机上通常是一个线程运行一个 CPU，如果一个计算机有 4 个 CPU 或者 CPU 有 4 个核心 ，然后照常运行 4 个实例在Same-threading 系统中（4个单线程系统），下面图例展示这个原理：
img

## 不共享 state 

一个 Same-threading 系统 看起来类似一个传统的多线程系统，然而一个 Same-threading 系统里有多个线程运行，但是这里有一些微妙的差异：

Same-threading 系统与传统多线程系统的差别是是否共享 state，在Same-threading 系统中不共享 state。没有通过线程并发访问共享内存，没有并发数据结构等，没有线程共享数据的方式。下面是展示不同的示意图：

缺乏共享状态是的每个线程运行情况就像单线程系统一样，仅仅是一个 Same-threading 系统可以包含多个单线程而已，他本质不是“单线程系统”。没有一个更好的名称，我觉得更适合叫 一个 Same-threading 系统，比一个使用单线程设计的多线程系统要好。Same-threading 简单易读并且简单理解。

Same-threading 本质意思是数据在一些线程上执行，并且 没有线程在 Same-threading 系统中并发的共享数据。有时也被称作，无状态并发或者独立状态并发。

## 负载均衡（Load Distribution）

很明显，一个 Same-threading 系统需要共享 work 加载在单线程实例运行中，如果仅有一个线程获得 work，系统实际上是单线程。

准确的说如何负载均衡不同线程依赖于系统的设计，下面小节中覆盖一部分例子：

### 单线程微服务

如果系统包括多个微服务，每个微服务运行在单线程模型中，当部署多个单线程微服务在同一台机器，每个微服务运行一个单线程在各自的 CPU 上。

微服务天然不会共享任何数据，所以微服务是一个 Same-threading 系统应用很好的案例。

### 数据分片服务

如果系统经常需要分片数据，或者很少使用数据库，可以使用数据库分片，分片的意思是数据分散在多个数据库上。数据是分离的，所有数据彼此关联是在同一个数据库的。例如，属于某个“所有者”实体的所有数据都将被插入到统一数据库。分片超出本教程的范围，此处不做赘述。

## 线程通信

Same-threading 系统中的线程需要通信，他们通过发送消息。如果线程 A 想给线程 B 发消息，线程 A 可以生成一个消息（一个比特流），线程 B 然后复制并读取消息（比特流）。在线程 B 读取复制和读取消息期间，需要确保线程 A 不能改变消息，一旦复制，线程 A 将无法访问消息。线程通信示意图如下：
img

线程通信可以是通道、管道、unix socket、tcp socket等任何符合系统的。

## 更简单的并发模型

Same-threading 系统中每个系统运行在他们自己的线程，可以被作为单线程的工具，化而言之并发模型从本质上比共享数据的线程模型要简单，不需要担心并发数据结构和数据结构造成的并发问题。

## 示例

这里有一些单线程、多线程和 Same-threading 系统的示例，可以更贱单的发现他们的不同

## java 线程 Ops

java 中线程 ops 是一个开元的工具，是的实现 Same-threading 系统分离状态更简单，线程ops 包括工具分离和停止单个进程，在单线程内实现一定程度的并发。在这个案例中，对 Same-threading 系统设计有兴趣，也希望能了解 thread ops，可以阅读更多关于 thread ops 在 其他教程中。